<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home Compass</title>
  <style>
    :root {
      --accent: #d7263d;
      --fg: #111;
      --muted: #666;
      --bg: #f7f7fb;
      --panel: #fff;
      --ring: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      text-align: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0;
      background: radial-gradient(1200px 800px at 50% -20%, #eef2ff 0%, var(--bg) 45%);
      color: var(--fg);
    }
    .wrap { max-width: 560px; margin: 0 auto; padding: 24px; }
    h1 { margin: 12px 0 20px; font-size: 28px; letter-spacing: 0.02em; }

    /* Compass */
    .compass-card { background: var(--panel); border-radius: 16px; padding: 20px; box-shadow: 0 6px 24px rgba(0,0,0,0.08); }
    #compass { width: 260px; height: 260px; display: block; margin: 0 auto; }
    #needle { transition: transform 0.4s cubic-bezier(.2,.8,.2,1); transform-box: fill-box; transform-origin: 50% 50%; }
    .subtitle { color: var(--muted); font-size: 14px; margin-top: 8px; }

    /* Controls */
    .controls { background: var(--panel); border-radius: 16px; padding: 16px; margin-top: 16px; box-shadow: 0 6px 24px rgba(0,0,0,0.06); }
    label { display: block; text-align: left; margin-top: 10px; font-size: 14px; color: var(--muted); }
    input[type=number] {
      width: 100%;
      appearance: textfield;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--ring);
      outline: none;
      font-size: 16px;
      margin-top: 6px;
      background: #fff;
    }
    .buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
    button {
      appearance: none;
      border: 0;
      padding: 12px 14px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #111827;
      color: #fff;
      box-shadow: 0 4px 14px rgba(0,0,0,.12);
    }
    button.secondary { background: #e5e7eb; color: #111; }
    button:disabled { opacity: .65; cursor: not-allowed; }

    #status { margin-top: 10px; min-height: 1.2em; color: var(--muted); font-size: 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>自宅コンパス</h1>
    <div class="compass-card">
      <svg id="compass" viewBox="0 0 200 200" aria-label="Compass">
        <!-- Dial -->
        <defs>
          <radialGradient id="dialGrad" cx="50%" cy="50%" r="60%">
            <stop offset="0%" stop-color="#ffffff" />
            <stop offset="100%" stop-color="#f3f4f6" />
          </radialGradient>
        </defs>
        <circle cx="100" cy="100" r="92" fill="url(#dialGrad)" stroke="#d1d5db" stroke-width="2" />
        <circle cx="100" cy="100" r="96" fill="none" stroke="#e5e7eb" stroke-width="2" />

        <!-- Cardinal letters -->
        <g font-family="system-ui, sans-serif" font-size="14" text-anchor="middle" fill="#374151">
          <text x="100" y="26">N</text>
          <text x="100" y="186">S</text>
          <text x="174" y="104">E</text>
          <text x="26" y="104">W</text>
        </g>

        <!-- Ticks -->
        <g stroke="#9ca3af" stroke-width="1">
          <!-- 12 major ticks -->
          <g transform="translate(100,100)">
            <!-- Generate 12 lines by rotating -->
            <line x1="0" y1="-80" x2="0" y2="-88" />
            <g transform="rotate(30)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
            <g transform="rotate(60)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
            <g transform="rotate(90)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
            <g transform="rotate(120)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
            <g transform="rotate(150)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
            <g transform="rotate(180)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
            <g transform="rotate(210)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
            <g transform="rotate(240)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
            <g transform="rotate(270)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
            <g transform="rotate(300)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
            <g transform="rotate(330)"><line x1="0" y1="-80" x2="0" y2="-88"/></g>
          </g>
        </g>

        <!-- Needle -->
        <g id="needle" transform="rotate(0 100 100)">
          <!-- North (red) -->
          <polygon points="100,22 108,100 92,100" fill="#ef4444" />
          <!-- South (gray) -->
          <polygon points="100,178 108,100 92,100" fill="#6b7280" />
          <!-- Hub -->
          <circle cx="100" cy="100" r="6" fill="#111827" />
        </g>
      </svg>
      <div id="status" class="subtitle"></div>
    </div>

    <div class="controls">
      <label>自宅の緯度
        <input id="home-lat" type="number" step="any" placeholder="例: 35.6804">
      </label>
      <label>自宅の経度
        <input id="home-lon" type="number" step="any" placeholder="例: 139.7690">
      </label>
      <div class="buttons">
        <button id="use-current">現在地を自宅に設定</button>
        <button id="save-home" class="secondary">自宅を保存</button>
      </div>
    </div>
  </div>
  <script>
    const needle = document.getElementById('needle');
    const statusEl = document.getElementById('status');
    const homeLatInput = document.getElementById('home-lat');
    const homeLonInput = document.getElementById('home-lon');
    let home = null;
    let currentPos = null;
    let orientationEnabled = false;

    function toRad(deg) { return deg * Math.PI / 180; }

    function bearingTo(lat1, lon1, lat2, lon2) {
      const φ1 = toRad(lat1);
      const φ2 = toRad(lat2);
      const Δλ = toRad(lon2 - lon1);
      const y = Math.sin(Δλ) * Math.cos(φ2);
      const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
      let θ = Math.atan2(y, x);
      θ = (θ * 180 / Math.PI + 360) % 360;
      return θ;
    }

    function loadHome() {
      const lat = localStorage.getItem('homeLat');
      const lon = localStorage.getItem('homeLon');
      if (lat && lon) {
        home = { lat: parseFloat(lat), lon: parseFloat(lon) };
        homeLatInput.value = lat;
        homeLonInput.value = lon;
      }
    }

    function saveHome() {
      const lat = parseFloat(homeLatInput.value);
      const lon = parseFloat(homeLonInput.value);
      if (isFinite(lat) && isFinite(lon)) {
        localStorage.setItem('homeLat', lat);
        localStorage.setItem('homeLon', lon);
        home = { lat, lon };
        statusEl.textContent = '自宅を保存しました。';
        return true;
      }
      statusEl.textContent = '緯度・経度が正しくありません。';
      return false;
    }

    function enableCompassFromGesture() {
      if (orientationEnabled) return Promise.resolve('already');
      // iOS 13+
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        return DeviceOrientationEvent.requestPermission().then(resp => {
          if (resp === 'granted') {
            window.addEventListener('deviceorientation', handleOrientation, true);
            orientationEnabled = true;
            statusEl.textContent = 'コンパスを有効化しました。';
            return 'granted';
          } else {
            statusEl.textContent = 'コンパスの権限が許可されませんでした。';
            return 'denied';
          }
        }).catch(() => {
          statusEl.textContent = 'コンパス権限の要求に失敗しました。';
          return 'error';
        });
      } else {
        // Other platforms auto-allowed
        if (!orientationEnabled) {
          window.addEventListener('deviceorientation', handleOrientation, true);
          orientationEnabled = true;
          statusEl.textContent = 'コンパスを有効化しました。';
        }
        return Promise.resolve('granted');
      }
    }

    function setHomeToCurrent() {
      navigator.geolocation.getCurrentPosition(
        pos => {
          homeLatInput.value = pos.coords.latitude;
          homeLonInput.value = pos.coords.longitude;
          const ok = saveHome();
          if (ok) {
            // As this runs inside a user gesture, request permission and enable
            enableCompassFromGesture();
          }
        },
        err => { statusEl.textContent = '現在地の取得に失敗しました: ' + err.message; }
      );
    }

    document.getElementById('save-home').addEventListener('click', () => {
      if (saveHome()) {
        // Also try to enable compass on manual save (still a user gesture)
        enableCompassFromGesture();
      }
    });
    document.getElementById('use-current').addEventListener('click', setHomeToCurrent);

    loadHome();

    navigator.geolocation.watchPosition(
      pos => { currentPos = pos.coords; },
      err => { statusEl.textContent = '位置情報の取得に失敗しました: ' + err.message; }
    );

    function handleOrientation(event) {
      if (!home || !currentPos) { return; }
      // Some platforms expose webkitCompassHeading (clockwise from North)
      const heading = typeof event.webkitCompassHeading === 'number' ? event.webkitCompassHeading : event.alpha;
      if (typeof heading !== 'number') { return; }
      const bearing = bearingTo(currentPos.latitude, currentPos.longitude, home.lat, home.lon);
      const diff = bearing - heading;
      needle.style.transform = `rotate(${diff}deg)`;
    }

    function initOrientation() {
      // If permissionless environment, attach immediately; otherwise we rely on button clicks (user gestures)
      if (typeof DeviceOrientationEvent === 'undefined' || typeof DeviceOrientationEvent.requestPermission !== 'function') {
        window.addEventListener('deviceorientation', handleOrientation, true);
        orientationEnabled = true;
      }
    }

    initOrientation();
  </script>
</body>
</html>
